## TCP / IP 网络模型

<!-- 这是什么东西来着 -->

- 同一设备上的进程间通信

  - 管道

  - 消息队列

  - 共享内存

  - 信号

- 不同设备之间的进程间通信 —— 网络通信
<!--  -->

- OSI 七层模型

  - [应用层](#应用层)： HTTP、HTTPS、FTP、SMTP、DNS —— HTML、应用程序、协议、数据

  - [表示层]()：格式转换 —— JPEG、GIF、MP3、MP4 —— 编码、压缩、加密、解密

  - [会话层]()：建立、管理、终止会话 —— RPC、NFS

  - [传输层](#传输层)：TCP、UDP —— 端口号、流量控制、拥塞控制

  - [网络层](#网络层)：IP、ICMP —— 路由器、网关

  - [数据链路层](#数据链路层])：物理地址寻址，ARP、RARP —— 交换机、网卡

  - [物理层](#物理层)：物理设备标准 —— RJ45



### 应用层

- 应用层 —— 工作在操作系统中的**用户态**，并不关心数据是如何传输的

- 传输层及以下 —— 工作在**内核态**

### 传输层

数据包超过 _MSS_ 会进行分段（_TCP Segment_）

- _MSS_ —— _TCP_ 最大报文段长度

_UDP_ 实现可靠传输 —— 在应用层上实现 _TCP_ 的特性

### 网络层

_IP_ 报文大小超过 _MTU_ 就会进行分片

_IP_ 地址

- 网络号 —— 标识 _IP_ 地址属于哪个子网
- 主机号 —— 标识同一子网下不同主机

### 数据链路层

_IP_ 地址 → _ARP_ 协议 → _MAC_ 地址

- _MAC_ 地址： 用于唯一标识设备

### 物理层

数据包 → 电信号

## _TCP_ 基本认识

- 网络层中的 _IP_ 协议是不可靠的

  - 不保证网络包的交付
  - 不保证网络包的按序交付
  - 不保证网络包的数据完整性

- _TCP_ 协议是面向连接的、可靠的、基于字节流的传输层通信协议

#### 确定一个 _TCP_ 连接

- 地址 —— _32_ 位，处于 _IP_ 头部中
  - 源地址
  - 目的地址
- 端口 —— _16_ 位，处于 _TCP_ 头部中
  - 源端口
  - 目的端口

#### _TCP_ 头部格式

![image-20211004161755344](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004161755344.png)

- 序列号 _Seq_ —— 每发送一次数据就会**累加**一次该数据字节数的大小
- 确认应答号 _Ack_ —— 下一次**期望收到**的数据的序列号

#### _UDP_ 头部格式

- _16_ 位源端口号 + _16_ 位目标端口号
- _16_ 位包长度 —— _UDP_ 首部长度 + 数据长度
- _16_ 位校验和

![image-20211004162130057](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004162130057.png)

#### ⭐*UDP* 和 _TCP_ 的区别？

- 连接
  - _TCP_ 是面向连接的，传输数据前要先建立连接
  - _UDP_ 是无连接的，即刻传输数据
- 服务对象
  - _TCP_ 是一对一的两点服务
  - _UDP_ 支持一对一、一对多、多对多的交互
- 可靠性
  - _TCP_ 是可靠交付数据的，数据可以无差错、不丢失、不重复、按需到达
  - _UDP_ 是**尽最大努力**交付，不保证可靠交付数据
- 拥塞控制、流量控制
  - _TCP_ 拥有拥塞控制和流量控制等特有机制，保证数据传输的安全性
  - _UDP_ 没有
- 首部开销
  - _TCP_ 首部**最少**有 20 个字节，如果使用了选项字段（例如重传机制中的 _SACK_）则会更长
  - _UDP_ 首部固定为 8 个字节
- 传输方式
  - _TCP_ 是流式传输
  - _UDP_ 是⼀个包⼀个包的发送
- 分片方式
  - _TCP_ 的数据大小如果大于 _MSS_，则会在传输层进行分片；**若丢失分片只需要传输丢失的分片即可**
  - _UDP_ 的数据大小如果大于 _MTU_，则会在 _IP_ 层进行分片；若丢失分片则需要重传所有数据包
- 应用场景
  - _TCP_ 能保证数据的可靠性交付 —— _FTP_ 文件传输 / _HTTP_ / _HTTPS_
  - _UDP_ 简单高效随时可发送数据 —— _DNS_ / 多媒体通信 / 广播通信

#### _MSS_ 与 _MTU_

![image-20211004164648110](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004164648110.png)

- _MTU_：⼀个网络包的最大长度，以太网中⼀般为 1500 字节
- _MSS_：除去 _IP_ 和 _TCP_ 头部之后，一个网络包所能容纳的 _TCP_ 数据的最大长度.

当如果⼀个 _IP_ 分片丢失，整个 _IP_ 报文的所有分片都得重传

## _TCP_ 连接建立

#### 三次握手

![image-20211004163150893](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004163150893.png)

- 握手之前

  - 客户端和服务端都处于 _CLOSED_ 状态
  - 服务端主动监听某个端口，处于 _LISTEN_ 状态

- 第一次握手：客户端 —— _SYN_ 报文 —— 服务端
  - 控制位上 _SYN_ 标志位置 1
  - 随机初始化序列号 _client_isn_
  - 客户端处于 _SYN-SENT_ 状态
- 第二次握手：服务端 —— _SYN_ + _ACK_ 报文 —— 客户端
  - _SYN_、_ACK_ 标志位置 1
  - 随机初始化序列号 server_isn
  - 确认应答号为 _client_isn + 1_
  - 服务器端处于 _SYN-RCVD_ 状态
- 第三次握手：客户端 —— _ACK_ 报文 —— 服务端
  - _ACK_ 标志位置 1
  - 序列号 _client_isn + 1_
  - 确认应答号为 _server_isn + 1_
  - 客户端处于 _ESTABLISHED_ 状态
  - 当服务器端收到第三次报文 —— _ESTABLISHED_ 状态
  - 第三次握手可以携带数据

#### 为什么是三次握手？

_TCP_ 建立连接时，通过三次握手能防止历史连接的建立，能减少双方不必要的资源开销，能帮助双方同步初始化序 列号。序列号能够保证数据包不重复、不丢弃和按序传输。

- 避免历史连接 —— 最主要原因
  - 在网络拥堵的情况下，某个 _SYN_ 报文未能及时到达，
  - 旧 _SYN_ 报文早于新 _SYN_ 报文
  - 三次握手可以避免历史连接
    - 若是历史连接，则客户端发送 _RST_ 报文 —— 服务端会终止这个历史连接
    - 如果不是历史连接 ，则客户端发送 _ACK_ 报文 —— 双方成功建立连接
- 同步双方的初始序列号 —— 序列号保证了数据包的不重复、不丢失、按序传输
- 避免浪费资源
  - 客户端收不到服务端的 _ACK + SYN_ 报文就会持续重传 _SYN_ 报文
  - 服务端每收到一个 _SYN_ 报文都会主动建立一个连接 —— 服务器会建立多个冗余的无效连接

## _TCP_ 连接断开

#### 四次挥手

![image-20211004165055442](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004165055442.png)

- 断开连接前，客户端和服务端都处于 _ESTABLISHED_ 状态
- 第一次挥手：客户端 —— _FIN_ 报文 —— 服务端
  - _FIN_ 标志位置 1
  - 客户端进入 _FIN_WAIT_1_ 状态
- 第二次挥手：服务端 —— _ACK_ 报文 —— 客户端
  - _ACK_ 标志位置 1
  - 服务端进入 _CLOSED_WAIT_ 状态
  - 客户端进入 _FIN_\_WAIT_2 状态
  - 此时服务端可能还有数据需要处理和发送
- 第三次挥手：服务端 —— _FIN_ 报文 —— 客户端
  - _FIN_ 标志位置 1
  - 服务端进入 _LAST_ACK_ 状态
- 第四次握手：客户端 —— _ACK_ 报文 —— 服务端
  - _ACK_ 标志位置 1
  - 客户端进入 TIME_WAIT 状态
  - 服务端收到 _ACK_ 报文后进入 _CLOSED_ 状态
  - ⭐ _2MSL_ 后客户端进入 _CLOSED_ 状态

#### 为什么 _TIME_WAIT_ 是 _2MSL_？

- _MSL_ —— 报文最大生存时间
- 计时点 —— 从客户端收到 _FIN_ 报文后发出 _ACK_ 报文开始计时
- 为什么是 _2MSL_？
  - 服务器未收到最后一个 _ACK_ 报文则触发超时重传 —— 最晚 _MSL_ 后到达
  - 超时重传所发送的 _FIN_ 报文最迟需要 _MSL_
  - 一来一回总共 _2MSL_

#### 为什么需要 _TIME_WAIT_ 状态

- 防止旧连接里延迟的数据包被下一次新连接所接收 —— 让旧的数据包自然消亡

###### ![image-20211004165940717](C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211004165940717.png)

- 保证连接正确关闭 —— 等待足够的时间以确保最后的 _ACK_ 报文能让被动关闭方接收到，从而正常关闭

## _TCP_ 特有机制

###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211116150414229.png" alt="image-20211116150414229" style="zoom: 80%;" />

#### 重传机制

用于解决数据包丢失的情况

- 超时重传 —— 指定时间 _RTO_ 内未收到对方的 _ACK_ 确定应答报文则重发数据

  - 超时重传时间 _RTO_ 应当**略大于** _RTT_ —— 数据包在网络中往返一次的时间

    ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117123719312.png" alt="image-20211117123719312" style="zoom:67%;" />

    - 如果 _RTO_ 过大 —— 重发过慢，导致效率低下
    - 如果 _RTO_ 过小 —— 可能导致未丢失就重发，从而增加网络拥塞

  - _RTT_ 是动态变化的 → _RTO_ 也是一个动态变化的值

- 快速重传

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117124247215.png" alt="image-20211117124247215" style="zoom:67%;" />

  - 工作方式 —— 当收到三个相同的 _ACK_ 报文时，会在**定时器过期之前**重传丢失的报文段
  - 局限性 —— 无法确定应该重传哪一些 _TCP_ 报文

- 选择性确认 _SACK_

  - 使用 —— 在 _TCP_ 首部选项里添加 _SACK_ 且双方都支持 _SACK_
  - 工作方式 —— 接收方发送缓存地图来告知发送方需要重传的缺失数据

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117124553358.png" alt="image-20211117124553358" style="zoom:67%;" />

- _D-SACK_ —— 使用 _SACK_ 告诉发送方被重复接收的数据

  - 情况一 —— 接收方接收到了数据但 _ACK_ 报文丢失，导致定时器过期后发送方重传了重复的数据
  - 情况二 —— 因为网络延迟的数据包到达时间晚于由快速重传所发送的相同数据包

#### 滑动窗口

- 传统传输方式 —— 对每个数据包都需要确认应答再发送下一个数据包

- 窗口 —— 无需等待确认应答就可以继续发送数据的最大值

  - 本质 —— 操作系统的一块缓存空间，收到确认应答后将数据从缓存区清除
  - 窗口大小 _window_ —— 接收端告知发送端可接受数据的缓冲区大小

- 发送方滑动窗口 —— 当接收到 _x_ 个*ACK* 确认应答后，则滑动窗口向右移动 _x_ 个字节

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117130527224.png" alt="image-20211117130527224"  />

  - 指针 _SND.WND_ —— 发送窗口大小
  - 绝对指针 _SND.UNA_ —— 指向已发送但未收到确认应答的第一个字节的序列号
  - 绝对指针 _SND.NXT_ —— 指向未发送但处于可发送范围内的第一个字节的序列号
  - 可用窗口大小 —— _SND.WND - (SND.NXT - SND.UNA)_

- 接收方滑动窗口

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117130943052.png" alt="image-20211117130943052"  />

  - 可接收窗口大小 _RCV.WND_
  - 绝对指针 _RCV.NXT_ —— _RCV.WND_ 中的第一个字节

#### 流量控制

- 目的 —— 让发送方根据接受方的实际接受能力控制发送的数据量

- 操作系统会对缓冲区做调整 —— 不允许同时减少缓存并收缩窗口

- 窗口关闭 —— 当窗口大小为 _0_ 时就会阻止发送方向接收方发送数据，直到窗口为非 0（接收方会发送非 _0_ 的 _ACK_ 报文通知发送方）

  - 危险 —— 若接收方告知发送方窗口非 _0_ 的 _ACK_ 报文丢失，则会造成死锁

  - 应对方法 —— 当出现 0 窗口通知就启动计时器并在超时后发送**窗口探测报文**

    ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117132234751.png" alt="image-20211117132234751" style="zoom:67%;" />

- 糊涂窗口综合征
  - 现象 —— 接收方通告一个小窗口而发送方义无反顾地发送对应大小的数据
  - 问题 —— 造成浪费
  - 应对方法
    - 避免接收方通告小窗口 —— 当窗口小于 _min(MSS, 1/2 缓存空间 )_ 则通告 _0_ 窗口
    - 避免发送方发送小数据 —— _Nagle_ 算法，即窗口大小/数据大小 _>= MSS_ 才允许发送数据

#### 拥塞控制

- ⭐ 与流量控制的区别

  - 流量控制是为了防止发送方发送的数据填满接受方的缓冲区
  - 拥塞控制是为了避免发送方发送的数据填满整个网络

- 慢启动 —— 每收到一个 _ACK_ 就将拥塞窗口 _cwnd_ +1

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117133432486.png" alt="image-20211117133432486" style="zoom:67%;" />

- 拥塞避免算法 —— 当拥塞窗口 _cwnd >=_ 慢启动门限 _ssthresh_，每收到一个 _ACK_ 就将拥塞窗口 _cwnd_ 增加 _1/cwnd_

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117133655635.png" alt="image-20211117133655635" style="zoom:67%;" />

- 拥塞发生算法 —— 触发重传机制时即判定网络发生了拥塞

  - 触发超时重传机制，即重传计时器超时 —— _ssthresh = cwnd / 2 & cwnd = 1_

    ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117134024375.png" alt="image-20211117134024375" style="zoom:67%;" />

  - 触发快速重传机制

    - 拥塞窗口 _cwnd = cwnd / 2_
    - 慢启动门限 _ssthresh = cwnd_
    - 进入快速恢复算法

- 快速恢复算法

  - 拥塞窗口 _cwnd = ssthresh + 3_
  - 重传丢失数据包
    - 如果收到重复 _ACK_ —— _cwnd + 1_
    - 如果收到新的 _ACK_ —— 进入拥塞避免状态

  ###### <img src="C:\Users\ThunderUp\AppData\Roaming\Typora\typora-user-images\image-20211117134729690.png" alt="image-20211117134729690" style="zoom:67%;" />
